# Dendrotector

Dendrotector is an instance segmentation pipeline tailored for spotting trees and shrubs on photographs. It combines [Grounding DINO](https://github.com/IDEA-Research/GroundingDINO) for grounding-free detection with [SAM 2](https://github.com/facebookresearch/sam2) to recover high-quality masks for each detected instance.

## Features

- Text-prompted detection for **trees, shrubs, and bushes** using Grounding DINO.
- High resolution per-instance masks generated by SAM 2.
- Export of bounding boxes, masks (with transparency), and a JSON summary for downstream processing.
- Overlay rendering with bounding boxes and colored masks for quick visual inspection.

## Installation

Create a virtual environment (recommended) and install the Python dependencies:

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

Grounding DINO and SAM 2 weights are downloaded automatically from the Hugging Face Hub on first use. Make sure you have enough disk space (~4 GB when using the larger SAM 2 checkpoints) and that you are logged in with `huggingface-cli login` if the models require authentication. Use the `--models-dir` flag (or the `models_dir` argument in the Python API) to override the default cache location and store all model files in a custom directory.

### Troubleshooting installation

The wheel published on PyPI for Grounding DINO (`groundingdino-py`) is currently missing
several CUDA source files. As a result, `pip install groundingdino-py` fails with an
error similar to:

```
cc1plus: fatal error: .../groundingdino/models/GroundingDINO/csrc/vision.cpp: No such file or directory
```

To avoid this issue the project depends directly on the official GitHub repository,
which provides the missing sources:

```bash
pip install git+https://github.com/IDEA-Research/GroundingDINO.git@v0.1.0-alpha2
```

Building the CUDA/C++ extension also requires a compiler toolchain and Ninja. On
Debian/Ubuntu you can install the prerequisites with:

```bash
sudo apt-get install build-essential ninja-build
```

If you install dependencies inside a managed environment (e.g. Google Colab), make
sure to run the command above before invoking `pip install -r requirements.txt`.

## Usage

```bash
python -m dendrotector path/to/image.jpg --output-dir results/
```

The command creates the following artifacts inside the chosen output directory:

- `*_detections.json`: List of detections with their label, confidence score, bounding box, and mask path.
- `*_instance_XX.png`: RGBA masks for each detected tree or shrub.
- `*_overlay.png`: Visualization of all detections drawn on top of the input image.

You can tweak the detection thresholds if you want to be more or less conservative:

```bash
python -m dendrotector path/to/image.jpg --box-threshold 0.25 --text-threshold 0.2

# Store all downloaded models inside ./weights instead of the default cache
python -m dendrotector path/to/image.jpg --models-dir weights
```

To run the detector on a specific device (e.g. CUDA) explicitly, pass `--device cuda`. On machines equipped with NVIDIA GPUs such as the H100, CUDA will be selected automatically when available.

## Programmatic API

```python
from dendrotector import DendroDetector

detector = DendroDetector(models_dir="weights")
results = detector.detect("forest.jpg", "outputs/forest")

for result in results:
    print(result.label, result.score, result.bbox, result.mask_path)
```

Each `DetectionResult` contains the predicted label (typically `"tree"` or `"bush"`), a confidence score, the pixel-space bounding box `[x0, y0, x1, y1]`, and a path to the saved mask PNG with transparency.

## Requirements

See [requirements.txt](requirements.txt) for the exact dependency list. GPU acceleration is highly recommended for fast inference, especially when processing large images.
